PHONY := all pki-gen pki-clean up down build rebuild clean fclean re logs ps help deps


SHELL := /bin/bash

# Couleurs pour les messages
GREEN := \033[0;32m
YELLOW := \033[0;33m
RED := \033[0;31m
ORANGE := \033[0;33m
WHITE := \033[1;37m
BOLD := \033[1m
NC := \033[0m # No Color

# Fichier-flag indiquant que la PKI a √©t√© g√©n√©r√©e
PKI_FLAG := .pki/.generated

# Docker compose wrapper
COMPOSE_FILE ?= compose.yml
COMPOSE := docker compose -f $(COMPOSE_FILE)

# Banner ASCII (simple)
define BANNER
$(WHITE)
  Transcendance - Makefile
$(NC)
endef
export BANNER

.PHONY: $(PHONY)

# Default target
all: help

## -----------------------------
## Section: PKI (g√©n√©ration de certificats)
## -----------------------------

# G√©n√©rer la PKI (expose la cible pki-gen)
pki-gen: $(PKI_FLAG)

$(PKI_FLAG): pki_gen.sh
	@echo "$(YELLOW)ÔøΩÔ∏è  G√©n√©ration des certificats PKI...$(NC)"
	@bash pki_gen.sh
	@mkdir -p $$(dirname $(PKI_FLAG))
	@touch $(PKI_FLAG)
	@echo "$(GREEN)‚úÖ Certificats g√©n√©r√©s ($(PKI_FLAG))$(NC)"

# Forcer la r√©g√©n√©ration (supprime le flag puis regen)
pki-clean:
	@echo "$(YELLOW)üßΩ Nettoyage PKI (flag) ...$(NC)"
	@rm -f $(PKI_FLAG)
	@echo "$(GREEN)‚úÖ Flag PKI supprim√© ‚Äî relancez 'make pki-gen' pour r√©g√©n√©rer.$(NC)"

## -----------------------------
## Section: Docker / orchestration
## -----------------------------

up: $(PKI_FLAG)
	@echo "$(YELLOW)ÔøΩ D√©marrage des conteneurs (compose file: $(COMPOSE_FILE))...$(NC)"
	@$(COMPOSE) up -d
	@echo "$(GREEN)‚úÖ Conteneurs d√©marr√©s$(NC)"
	@$(COMPOSE) ps

down:
	@echo "$(YELLOW)üõë Arr√™t des conteneurs...$(NC)"
	@$(COMPOSE) down
	@echo "$(GREEN)‚úÖ Conteneurs arr√™t√©s$(NC)"

build:
	@echo "$(YELLOW)üî® Construction des images...$(NC)"
	@$(COMPOSE) build
	@echo "$(GREEN)‚úÖ Images construites$(NC)"

rebuild: down
	@echo "$(YELLOW)üî® Reconstruction compl√®te (no-cache)...$(NC)"
	@$(COMPOSE) build --no-cache
	@rm -f $(PKI_FLAG)
	@$(MAKE) $(PKI_FLAG)
	@$(COMPOSE) up -d
	@echo "$(GREEN)‚úÖ Rebuild termin√©$(NC)"

logs:
	@$(COMPOSE) logs -f

ps:
	@$(COMPOSE) ps

clean:
	@echo "$(YELLOW)üßπ Nettoyage des conteneurs et r√©seaux...$(NC)"
	@$(COMPOSE) down -v
	@echo "$(GREEN)‚úÖ Nettoyage termin√©$(NC)"

fclean: clean
	@echo "$(RED)üóëÔ∏è  Suppression compl√®te (images + certificats)...$(NC)"
	@$(COMPOSE) down -v --rmi all
	@rm -rf gateway/ssl/*.pem bff/ssl/*.pem .pki 2>/dev/null || true
	@echo "$(GREEN)‚úÖ Nettoyage complet termin√©$(NC)"

re: fclean all

## -----------------------------
## Gestion des d√©pendances
## -----------------------------

# Utilise mmd-mp si disponible, sinon fait un 'docker compose pull'
deps:
	@echo "$(YELLOW)üîó Gestion des d√©pendances...$(NC)"
	@if command -v mmd-mp >/dev/null 2>&1; then \
		echo "‚Üí mmd-mp trouv√© : ex√©cution de 'mmd-mp install' (hypoth√®se)"; \
		mmd-mp install; \
	else \
		echo "‚Üí mmd-mp non trouv√© : fallback = '$(COMPOSE) pull'"; \
		$(COMPOSE) pull --ignore-pull-failures; \
	fi

## -----------------------------
## Aide / documentation
## -----------------------------

help:
	@echo "$(GREEN)Transcendance - Makefile - Sections disponibles:$(NC)"
	@echo ""
	@echo "PKI:" 
	@echo "  $(YELLOW)make pki-gen$(NC)    - G√©n√®re la PKI via ./pki_gen.sh (cr√©e $(PKI_FLAG))"
	@echo "  $(YELLOW)make pki-clean$(NC)  - Supprime le flag de g√©n√©ration PKI"
	@echo ""
	@echo "Docker (utilise $(COMPOSE_FILE)) :"
	@echo "  $(YELLOW)make up$(NC)         - G√©n√®re la PKI si n√©cessaire puis d√©marre les conteneurs"
	@echo "  $(YELLOW)make down$(NC)       - Arr√™te les conteneurs"
	@echo "  $(YELLOW)make build$(NC)      - Construit les images"
	@echo "  $(YELLOW)make rebuild$(NC)    - Rebuild complet et restart"
	@echo "  $(YELLOW)make logs$(NC)       - Affiche les logs"
	@echo "  $(YELLOW)make ps$(NC)         - Statut des conteneurs"
	@echo "  $(YELLOW)make clean$(NC)      - Nettoyage conteneurs + volumes"
	@echo "  $(YELLOW)make fclean$(NC)     - Nettoyage complet (images + certificats)"
	@echo ""
	@echo "Autre:" 
	@echo "  $(YELLOW)make deps$(NC)       - G√®re les d√©pendances : utilise 'mmd-mp' si pr√©sent, sinon 'docker compose pull'"
	@echo "  $(YELLOW)make help$(NC)       - Affiche cette aide"

